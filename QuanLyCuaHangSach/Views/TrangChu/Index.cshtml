@model IEnumerable<QuanLyCuaHangSach.Models.Sach>

@if (Model.Any())
{
    <h3>Có @Model.Count() sách</h3>
}
else
{
    <h3>Không có sách nào</h3>
}


<div class="row" style="margin-top: 20px; margin-bottom: 20px;">
    <!-- Cột thể loại bên trái -->
    <div class="col-md-2" style="background-color: #f4e1d2; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);">
        <h4 style="color: #8b4513; font-size: 1.2rem; font-weight: bold;">Thể loại</h4>
        <ul class="list-group" style="margin-top: 15px;">
            <li class="list-group-item" style="padding: 10px; background-color: #ffffff; border: 1px solid #d5b29a; border-radius: 5px; margin-bottom: 5px;">
                <a asp-action="Index" asp-route-theLoaiId="" title="Hiển thị tất cả các sách" data-bs-toggle="tooltip" style="color: #8b4513; text-decoration: none;">Tất cả</a>
            </li>
            @foreach (var theLoai in ViewBag.DanhSachTheLoai)
            {
                <li class="list-group-item" style="padding: 10px; background-color: #ffffff; border: 1px solid #d5b29a; border-radius: 5px; margin-bottom: 5px;">
                    <a asp-action="Index" asp-route-theLoaiId="@theLoai.MaTheLoai" title="@theLoai.MoTa" data-bs-toggle="tooltip" style="color: #8b4513; text-decoration: none;">
                        @theLoai.TenTheLoai
                    </a>
                </li>
            }
        </ul>
    </div>

    <!-- Cột sách + tìm kiếm bên phải -->
    <div class="col-md-9" style="padding-left: 15px;">
        <div class="d-flex mb-3">
            <input type="text"
                   id="searchBox"
                   class="form-control"
                   placeholder="Tìm kiếm sách..."
                   value="@ViewBag.SearchString"
                   style="max-width: 100%; border-radius: 8px; padding: 10px; font-size: 1rem; border: 1px solid #d5b29a; background-color: #f9f9f9;" />
        </div>

        <!-- Đây là chỗ sẽ được load lại nguyên vẹn _ListWrapper -->
        @await Html.PartialAsync("_ListWrapper", Model)

        <!-- Form duy nhất để submit đặt thuê -->
        <form id="datThueForm" asp-controller="PhieuDatTruoc" asp-action="TaoPhieu" method="post" style="display:none;">
            <input type="hidden" id="modalMaSach" name="maSach" value="" />
            <input type="hidden" name="maTaiKhoan" value="@ViewBag.MaTaiKhoan" />
        </form>

        <!-- Modal duy nhất -->
        <div class="modal fade" id="xacNhanModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content" style="background-color: #fff8f0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">
                    <div class="modal-header" style="background-color: #f0ebe3; border-bottom: none; padding: 1rem 1.5rem;">
                        <h5 class="modal-title" style="color: #4a90e2; font-size: 1.25rem; font-weight: 600;">
                            Xác nhận đặt thuê
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(30%);"></button>
                    </div>
                    <div class="modal-body" style="color: #333333; font-size: 1rem; padding: 1rem 1.5rem;">
                        Bạn có chắc chắn muốn đặt thuê quyển sách này không?
                    </div>
                    <div class="modal-footer" style="background-color: #f9f9f9; border-top: none; padding: 1rem 1.5rem;">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="background-color: #7ed6df; color: #333333; border: none; border-radius: 5px; padding: 0.5rem 1rem; font-size: 1rem;">
                            Hủy
                        </button>
                        <button type="button" class="btn btn-primary" id="xacNhanDatThue" style="background-color: #4a90e2; color: #ffffff; border: none; border-radius: 5px; padding: 0.5rem 1rem; font-size: 1rem;">
                            Xác nhận
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Kích hoạt tooltip của Bootstrap -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
                delay: { show: 500, hide: 100 } // Hiện sau 1s, ẩn nhanh sau 100ms
            });
        });
    });
</script>

<script>
    // Khi click "Đặt thuê" trên từng card, gán maSach vào form ẩn
    function prepareDatThue(maSach) {
        document.getElementById("modalMaSach").value = maSach;
    }

    // Khi click "Xác nhận" trong modal, submit form chung
    document.getElementById("xacNhanDatThue")
        .addEventListener("click", function () {
            document.getElementById("datThueForm").submit();
        });
</script>

<script>
    function themVaoGio(maSach) {
        $.post("/GioHang/ThemVaoGio", { maSach: maSach }, function (response) {
            if (response.success) {
                loadGioHang(); // Cập nhật lại giỏ hàng
                alert("Sách đã thêm vào giỏ hàng!");
            } else {
                alert("Có lỗi xảy ra, vui lòng thử lại!");
            }
        });
    }
</script>

<script>
    const searchBox = document.getElementById("searchBox");
    const listWrapper = document.getElementById("listWrapper");
    let debounce;

    function loadPage(page = 1) {
        const q = encodeURIComponent(searchBox.value);
        const tl = '@ViewBag.CurrentTheLoaiId';
        const url = `/TrangChu/TimKiemPhanTrang?pageNumber=${page}`
            + `&searchString=${q}`
            + (tl ? `&theLoaiId=${tl}` : '');

        fetch(url)
            .then(r => r.text())
            .then(html => {
                listWrapper.innerHTML = html;
                bindPaginationLinks();
            });
    }

    function bindPaginationLinks() {
        listWrapper.querySelectorAll('#pagination a[data-page]')
            .forEach(a => {
                a.onclick = e => {
                    e.preventDefault();
                    loadPage(a.getAttribute('data-page'));
                };
            });
    }

    // Khi gõ tìm kiếm: đợi 500ms rồi load lại trang 1
    searchBox.addEventListener('input', () => {
        clearTimeout(debounce);
        debounce = setTimeout(() => loadPage(1), 500);
    });

    // Khởi tạo bind cho lần đầu
    document.addEventListener('DOMContentLoaded', bindPaginationLinks);
</script>
